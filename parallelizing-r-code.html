<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>R for the HPCC: Parallelizing your R code with <code>future</code></title><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" type="text/css" href="assets/styles.css"><script src="assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [ ['$','$'], ['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png"><link rel="manifest" href="site.webmanifest"><link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" content="#ffffff"></head><body>
    <header id="top" class="navbar navbar-expand-md navbar-light bg-white top-nav software"><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-6">
      <div class="large-logo">
        <img alt="ICER" src="assets/images/icer-rectangle.png"><abbr class="icon" title="This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught." style="text-decoration: unset">
           
          <a href="https://cdh.carpentries.org/the-lesson-life-cycle.html#early-development-pre-alpha-through-alpha" class="external-link alert-link" style="color: #383838">Pre-Alpha
            <i aria-hidden="true" class="icon" data-feather="alert-octagon" style="color: #FF4955; border-radius: 5px"></i>
          </a>
          <span class="visually-hidden">This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.</span>
        </abbr>
        
      </div>
    </div>
    <div class="selector-container ">
      
      
      <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Learner View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1"><li><button class="dropdown-item" type="button" onclick="window.location.href='instructor/parallelizing-r-code.html';">Instructor View</button></li>
        </ul></div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl navbar-light bg-white bottom-nav software" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="ICER" src="assets/images/icer-square.png"></div>
    <div class="lesson-title-md">
      R for the HPCC
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
      <i role="img" aria-label="search button" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item">
          <span class="lesson-title">
            R for the HPCC
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="reference.html#glossary">Glossary</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="profiles.html">Learner Profiles</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown"><li><a class="dropdown-item" href="reference.html">Reference</a></li>
          </ul></li>
      </ul></div>
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled><input class="form-control me-2 searchbox" type="search" placeholder="Search" aria-label="Search"><button class="btn btn-outline-success tablet-search-button" type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="search button"></i>
        </button>
      </fieldset></form>
  </div><!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  R for the HPCC
</div>

<aside class="col-md-12 lesson-progress"><div style="width: 60%" class="percentage">
    60%
  </div>
  <div class="progress software">
    <div class="progress-bar software" role="progressbar" style="width: 60%" aria-valuenow="60" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
  <div id="sidebar-col" class="col-lg-4">
    <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle"><i class="search-icon" data-feather="x" role="img"></i></button>
        <div class="sidebar-inner">
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Learner View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="instructor/parallelizing-r-code.html">Instructor View</a>
                      </div>
                    </div>
                  </div><!--/div.accordion-item-->
                </div><!--/div.accordion-flush-->
              </div><!--div.sidenav-view-selector -->
            </div><!--/div.col -->
      
            <hr></div><!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Setup</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="rstudio-ondemand.html">1. Accessing RStudio through OnDemand</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="managing-r-env-packages.html">2. Managing R package installation and environment</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="r-command-line.html">3. Using R on the command line</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlushcurrent">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-headingcurrent">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapsecurrent" aria-expanded="true" aria-controls="flush-collapsecurrent">
        <span class="visually-hidden">Current Chapter</span>
        <span class="current-chapter">
        4. Parallelizing your R code with <code>future</code>
        </span>
      </button>
    </div><!--/div.accordion-header-->
        
    <div id="flush-collapsecurrent" class="accordion-collapse collapse show" aria-labelledby="flush-headingcurrent" data-bs-parent="#accordionFlushcurrent">
      <div class="accordion-body">
        <ul><li><a href="#basics-of-parallelization">Basics of parallelization</a></li>
<li><a href="#writing-code-that-runs-on-multiple-cores">Writing code that runs on multiple cores</a></li>
<li><a href="#writing-code-that-runs-on-multiple-nodes">Writing code that runs on multiple nodes</a></li>
<li><a href="#the-cluster-backend">The cluster backend</a></li>
<li><a href="#the-batchtools.slurm-backend">The batchtools.slurm backend</a></li>
        </ul></div><!--/div.accordion-body-->
    </div><!--/div.accordion-collapse-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="r-slurm-jobs.html">5. r-slurm-jobs</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width"><div class="accordion accordion-flush resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul><li>
                        <a href="key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="reference.html#glossary">Glossary</a>
                      </li>
                      <li>
                        <a href="profiles.html">Learner Profiles</a>
                      </li>
                      <li><a href="reference.html">Reference</a></li>
                    </ul></div>
                </div>
              </div>
            </div>
            <hr class="half-width resources"><a href="aio.html">See all in one page</a>

            <hr class="d-none d-sm-block d-md-none"><div class="d-grid gap-1">
            
            </div>
          </div><!-- /div.accordion -->
        </div><!-- /div.sidebar-inner -->
      </nav></div><!-- /div.sidebar -->
  </div><!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-instructor.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <nav class="lesson-content mx-md-4" aria-label="Previous and Next Chapter"><!-- content for small screens --><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="r-command-line.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="r-slurm-jobs.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="r-command-line.html" rel="prev"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous: Using R on the</a>
        <a class="chapter-link float-end" href="r-slurm-jobs.html" rel="next">Next: r-slurm-jobs... <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <hr></nav><main id="main-content" class="main-content"><div class="container lesson-content">
        <h1>Parallelizing your R code with <code>future</code></h1>
        <p> Last updated on 2023-06-16 | 
        
        <a href="https://github.com/cgross95/r-for-hpcc/edit/main/episodes/parallelizing-r-code.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
        
        
        
        <div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>

        

<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul><li>How can you use HPCC resources to make your R code run faster?</li>
</ul></div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul><li>Introduce the R package <code>future</code>
</li>
<li>Demonstrate some simple ways to parallelize your code with
<code>foreach</code> and <code>future_lapply</code>
</li>
<li>Explain different parallelization backends</li>
</ul></div>
</div>
</div>
</div>
</div>
<section id="basics-of-parallelization"><h2 class="section-heading">Basics of parallelization<a class="anchor" aria-label="anchor" href="#basics-of-parallelization"></a>
</h2>
<hr class="half-width"><p>The HPCC is made up of lots of computers that have processors with
lots of cores. Your laptop probably has a processor with 4-8 cores while
the largest nodes on the HPCC have 128 cores.</p>
<p>All this said though, HPCC nodes are <em>not</em> inherently faster
than standard computers. In fact, having many cores in a processor
usually come at the cost of slightly slower processing speeds. One of
the primary benefits of running on the HPCC is that that you can speed
up your throughput by doing many tasks at the same time on multiple
processors, nodes, or both. This is called running your code in
<em>parallel</em>.</p>
<p>Except for a few exceptions (like linear algebra routines), this
speedup isn’t automatic! You will need to make some changes to your code
so it knows what resources to use and how to split up its execution
across those resources. We’ll use the “<a href="https://www.futureverse.org/" class="external-link">Futureverse</a>” of R packages to
help us do this quickly.</p>
</section><section id="writing-code-that-runs-on-multiple-cores"><h2 class="section-heading">Writing code that runs on multiple cores<a class="anchor" aria-label="anchor" href="#writing-code-that-runs-on-multiple-cores"></a>
</h2>
<hr class="half-width"><p>Let’s start with a small example of some code that can be sped up by
running in parallel. In RStudio, create a new R Script and enter the
following code:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t</span> <span class="op">&lt;-</span> <span class="fu">proc.time</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span></span>
<span><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu">rep</span><span class="op">(</span><span class="cn">NA</span>, <span class="fu">length</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>  <span class="co"># Preallocate the result vector</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu">seq_along</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">Sys.sleep</span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span></span>
<span>  <span class="va">z</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">sqrt</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">print</span><span class="op">(</span><span class="fu">proc.time</span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="va">t</span><span class="op">)</span></span></code></pre>
</div>
<p>Create a new directory in your <code>r_workshop</code> project called
<code>src</code> and save it as <code>src/test_sqrt.R</code>. Click the
Source button at the top of the editor window in RStudio, and see the
output:</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>   user  system elapsed 
  0.016   0.009   5.006</code></pre>
</div>
<p>This means that it took about 5 seconds for the code to run. Of
course, this all came from us asking the code to sleep for half a second
each loop iteration! This is just to simulate a long running chunk of
code that we might want to parallelize.</p>
<div id="a-digression-on-vectorization" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="a-digression-on-vectorization" class="callout-inner">
<h3 class="callout-title">A digression on vectorization<a class="anchor" aria-label="anchor" href="#a-digression-on-vectorization"></a>
</h3>
<div class="callout-content">
<p>Ignoring the <code>Sys.sleep(0.5)</code> part of our loop, if we just
wanted the square root of all of the elements in <code>x</code>, we
should never use a loop! R thrives with vectorization, meaning that we
can apply a function to a whole vector at once. This will also trigger
some of those linear algebra libraries that can auto-parallelize some of
your code.</p>
<p>For example, compare</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t</span> <span class="op">&lt;-</span> <span class="fu">proc.time</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span></span>
<span><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu">rep</span><span class="op">(</span><span class="cn">NA</span>, <span class="fu">length</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>  <span class="co"># Preallocate the result vector</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu">seq_along</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span><span class="va">z</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">sqrt</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">print</span><span class="op">(</span><span class="fu">proc.time</span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="va">t</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>   user  system elapsed 
  0.004   0.000   0.005 </code></pre>
</div>
<p>to</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t</span> <span class="op">&lt;-</span> <span class="fu">proc.time</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span></span>
<span><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu">sqrt</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">print</span><span class="op">(</span><span class="fu">proc.time</span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="va">t</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>   user  system elapsed 
      0       0       0 </code></pre>
</div>
<p>Not only is the vectorized code much cleaner, it’s much faster
too!</p>
</div>
</div>
</div>
<p>Let’s parallelize this with a combination of the <code>foreach</code>
and the <code>doFuture</code> packages. Add the following lines to the
end of your <code>test_sqrt.R</code> script:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">foreach</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">doFuture</span><span class="op">)</span></span>
<span><span class="fu">plan</span><span class="op">(</span><span class="va">sequential</span><span class="op">)</span></span>
<span></span>
<span><span class="va">t</span> <span class="op">&lt;-</span> <span class="fu">proc.time</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span></span>
<span><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu">foreach</span><span class="op">(</span>xi <span class="op">=</span> <span class="va">x</span><span class="op">)</span> <span class="op">%dofuture%</span> <span class="op">{</span></span>
<span>  <span class="fu">Sys.sleep</span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span></span>
<span>  <span class="fu">sqrt</span><span class="op">(</span><span class="va">xi</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">print</span><span class="op">(</span><span class="fu">proc.time</span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="va">t</span><span class="op">)</span></span></code></pre>
</div>
<p>Notice that this is very close to our original code, but we made a
few changes:</p>
<ul><li>We changed the <code>for</code> loop with a <code>foreach</code>
statement.
<ul><li>The <code>xi = x</code> lets us iterate over <code>x</code> and use
<code>xi</code> as an element rather than indexing.</li>
<li>The block that happens on each “iteration” is preceded by
<code>%dofuture%</code>. This tells <code>foreach</code> how to run each
of the iterations, and in this case, uses the <code>future</code>
package behind the scenes.</li>
</ul></li>
<li>
<code>z</code> is now the output of <code>foreach</code> statement
rather than preallocated and subsequently changed on each iteration of
the <code>for</code> loop. Each element is the last result of the code
block for each input <code>xi</code>.</li>
</ul><p>Let’s run the code:</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>   user  system elapsed 
  0.050   0.012   5.051</code></pre>
</div>
<p>Huh? It’s slower! Well, we forgot one thing. We changed our code to
get ready for parallelization, but we didn’t say <em>how</em> we want to
parallelize it.</p>
<p>Well, actually, we did. The <code>plan(sequential)</code> line tells
<code>future</code> that we want to run each loop iteration
sequentially, i.e., the same exact way the original for loop works! We
just added some extra overhead of using the extra packages.</p>
<div class="section level3">
<h3 id="the-multisession-backend">The multisession backend<a class="anchor" aria-label="anchor" href="#the-multisession-backend"></a></h3>
<p>To parallelize things, we change the plan. There are a few options,
but we’ll start with the <code>multisession</code> plan. Change the
<code>plan(sequential)</code> to <code>plan(multisession)</code> and run
again:</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>   user  system elapsed 
  0.646   0.019   2.642</code></pre>
</div>
<p>Much better! What future did behind the scenes is check how many
cores we have allotted to our RStudio session with</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">availableCores</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="va">cgroups.cpuset</span> </span>
<span>             <span class="fl">8</span></span></code></pre>
</div>
<p>and make that many R sessions in the background. Each of these
sessions gets a loop iteration to run, and when finished, if there are
still more, it will run another one.</p>
<p>We can tell <code>future</code> to use a certain number of workers in
the <code>plan</code>, which will override the number of cores. Add the
<code>workers</code> option to <code>plan(multisession)</code> like</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plan</span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre>
</div>
<p>and rerun to get</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>   user  system elapsed 
  0.327   0.010   1.923 </code></pre>
</div>
<p>It’s even faster! With five workers, each worker has exactly two
iterations to work on, and we don’t have the overhead of the three extra
ones that wait around to do nothing.</p>
</div>
<div class="section level3">
<h3 id="the-multicore-backend">The multicore backend<a class="anchor" aria-label="anchor" href="#the-multicore-backend"></a></h3>
<p>In addition to a <code>multisession</code> plan, we can also utilize
all of our cores with the <code>multicore</code> plan. Instead of
starting multiple R sessions, <code>future</code> forks the main process
into as many processes as specified workers. This generally has less
overhead, and one major advantage is that all of the workers share the
memory of the original process. In the <code>multisession</code> plan,
each worker copied the bit of <code>x</code> it had to work on into new
memory which can really add up for large inputs. However, in the
<code>multicore</code> case, since the memory is shared, it is not
writable.</p>
<p>Unfortunately, the <code>multicore</code> plan is less stable in GUI
environments like RStudio. Thus, it can only be used in scripts <a href="r-command-line.html">running from the command line</a>, so we will
ignore it for now.</p>
</div>
</section><section id="writing-code-that-runs-on-multiple-nodes"><h2 class="section-heading">Writing code that runs on multiple nodes<a class="anchor" aria-label="anchor" href="#writing-code-that-runs-on-multiple-nodes"></a>
</h2>
<hr class="half-width"></section><section id="the-cluster-backend"><h2 class="section-heading">The cluster backend<a class="anchor" aria-label="anchor" href="#the-cluster-backend"></a>
</h2>
<hr class="half-width"><p>To use the <code>cluster</code> backend, you need a list of nodes you
can access through SSH. Usually, you would submit a SLURM job requesting
multiple nodes and use these, but we will save that for <a href="r-slurm-jobs.html">a future section</a>.</p>
<p>For now, we’ll practice by using some development nodes. Replace the
<code>plan</code> line with the following:</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hostnames</span> <span class="op">&lt;-</span> <span class="fu">c</span><span class="op">(</span><span class="st">"dev-amd20"</span>, <span class="st">"dev-intel18"</span><span class="op">)</span></span>
<span><span class="fu">plan</span><span class="op">(</span><span class="va">cluster</span>, workers <span class="op">=</span> <span class="va">hostnames</span><span class="op">)</span></span></code></pre>
</div>
<p>and run:</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Error: there is no package called 'doFuture'</code></pre>
</div>
<p>Hmm, something went wrong. It turns out that <code>future</code>
isn’t always sure what’s available on the hosts we pass it to build the
cluster with. We have to tell it what library path to use, and that it
should set the working directory on each node to our current working
directory.</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hostnames</span> <span class="op">&lt;-</span> <span class="fu">c</span><span class="op">(</span><span class="st">"dev-amd20"</span>, <span class="st">"dev-intel18"</span><span class="op">)</span></span>
<span><span class="va">wd</span> <span class="op">&lt;-</span> <span class="fu">getwd</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">setwd_cmd</span> <span class="op">&lt;-</span> <span class="fu">cat</span><span class="op">(</span><span class="st">"setwd('"</span>, <span class="va">wd</span>, <span class="st">"')"</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span><span class="fu">plan</span><span class="op">(</span><span class="va">cluster</span>, workers <span class="op">=</span> <span class="va">hostnames</span>,</span>
<span>     rscript_libs <span class="op">=</span> <span class="fu">.libPaths</span><span class="op">(</span><span class="op">)</span>,</span>
<span>     rscript_startup <span class="op">=</span> <span class="va">setwd_cmd</span><span class="op">)</span></span></code></pre>
</div>
<p>Now let’s run again:</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>setwd('/mnt/ufs18/home-237/k0068027/r_workshop')   user  system elapsed 
  0.233   0.044   2.769 </code></pre>
</div>
<p>The output is a little wonky because it runs the
<code>rscript_startup</code> command, but we were still able to save
some time!</p>
</section><section id="the-batchtools.slurm-backend"><h2 class="section-heading">The batchtools.slurm backend<a class="anchor" aria-label="anchor" href="#the-batchtools.slurm-backend"></a>
</h2>
<hr class="half-width"><div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul><li>Use <code>.md</code> files for episodes when you want static
content</li>
<li>Use <code>.Rmd</code> files for episodes when you need to generate
output</li>
<li>Run <code>sandpaper::check_lesson()</code> to identify any issues
with your lesson</li>
<li>Run <code>sandpaper::build_lesson()</code> to preview your lesson
locally</li>
</ul></div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></div> <!-- / div.lesson-content -->
    </main><!-- / main#main-content.main-content --><nav class="bottom-pagination mx-md-4" aria-label="Previous and Next Chapter"><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="r-command-line.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="r-slurm-jobs.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="r-command-line.html" rel="prev"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous: Using R on the</a>
        <a class="chapter-link float-end" href="r-slurm-jobs.html" rel="next">Next: r-slurm-jobs... <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
    </nav></div> <!-- / div.primary-content.col-xs-12 -->
<!-- END:   inst/pkgdown/templates/content-instructor.html-->

      </div><!--/div.row-->
      		<footer class="row footer mx-md-3"><hr><div class="col-md-6">
				<p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>
        
        <a href="https://github.com/cgross95/r-for-hpcc/edit/main/episodes/parallelizing-r-code.Rmd" class="external-link">Edit on GitHub</a>
        
	
        | <a href="https://github.com/cgross95/r-for-hpcc/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a> 
        | <a href="https://github.com/cgross95/r-for-hpcc/" class="external-link">Source</a></p>
				<p><a href="https://github.com/cgross95/r-for-hpcc/blob/main/CITATION" class="external-link">Cite</a> | <a href="mailto:grosscra@msu.edu">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">
        
        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>
        
        <p><a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">Template licensed under CC-BY 4.0</a> by <a href="https://carpentries.org" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.12.4" class="external-link">sandpaper (0.12.4)</a>,
        <a href="https://github.com/carpentries/pegboard" class="external-link">pegboard (0.5.3)</a>,
      and <a href="https://github.com/cgross95/varnish/tree/icer" class="external-link">varnish (0.2.17)</a>.</p>
			</div>
		</footer></div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
			<i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back to top"></i><br><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "TrainingMaterial",
  "@id": "https://cgross95.github.io/r-for-hpcc/parallelizing-r-code.html",
  "dct:conformsTo": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "r, hpcc, parallel, cluster, icer",
  "name": "Parallelizing your R code with future",
  "creativeWorkStatus": "active",
  "url": "https://cgross95.github.io/r-for-hpcc/parallelizing-r-code.html",
  "identifier": "https://cgross95.github.io/r-for-hpcc/parallelizing-r-code.html",
  "dateCreated": "2023-06-30",
  "dateModified": "2023-06-16",
  "datePublished": "2023-06-20"
}

  </script><script>
		feather.replace();
	</script><!-- Matomo
    2022-11-07: we have gotten a notification that we have an overage for our
    tracking and I'm pretty sure this has to do with Workbench usage.
    Considering that I am not _currently_ using this tracking because I do not
    yet know how to access the data, I am turning this off for now.
  <script>
    var _paq = window._paq = window._paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(["setDocumentTitle", document.domain + "/" + document.title]);
    _paq.push(["setDomains", ["*.preview.carpentries.org","*.datacarpentry.github.io","*.datacarpentry.org","*.librarycarpentry.github.io","*.librarycarpentry.org","*.swcarpentry.github.io", "*.carpentries.github.io"]]);
    _paq.push(["setDoNotTrack", true]);
    _paq.push(["disableCookies"]);
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
          var u="https://carpentries.matomo.cloud/";
          _paq.push(['setTrackerUrl', u+'matomo.php']);
          _paq.push(['setSiteId', '1']);
          var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
          g.async=true; g.src='https://cdn.matomo.cloud/carpentries.matomo.cloud/matomo.js'; s.parentNode.insertBefore(g,s);
        })();
  </script>
  End Matomo Code --></body></html><!-- END:   inst/pkgdown/templates/layout.html-->

